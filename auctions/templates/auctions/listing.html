{% extends "auctions/layout.html" %}

{% block body %}
    {% if error_message %}
        <h2>No Listing Found</h2>
    {% else %}
        <div class="listing-page">
            <div class="listing-page-content">
                <div class="listing-page-header">
                    <div class="listing-page-title">
                        <p class="breadcrumb"><a href="{% url 'index' %}">Listings ></a></p>
                        <h1>{{ listing.title }}</h1>
                    </div>
                    <div class="listing-page-status">
                        {% if listing.is_active == True %}
                            <div class="status-icon active">Active</div>
                        {% else %}
                            <div class="status-icon finished">Finished</div>
                        {% endif %}
                    </div>
                </div>
                {% if listing.photo_url %}
                    <img src="{{ listing.photo_url}}" alt="{{ listing.title }}">
                {% endif %}
                <h3>Description</h3>
                <p>{{ listing.description }}</p>
                {% if user.is_authenticated and user != listing.user %}
                    <form id="watchlist-toggle" action="{% url 'listing' listing.id %}" method="post">
                        {% csrf_token %}
                        {% if is_watchlist == False %}
                            <button name="toggle-watchlist" value="toggle-watchlist" class="watchlist-false">
                                <svg style="width:18px;height:18px" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M5.8 21L7.4 14L2 9.2L9.2 8.6L12 2L14.8 8.6L22 9.2L18.8 12H18C14.9 12 12.4 14.3 12 17.3L5.8 21M17 14V17H14V19H17V22H19V19H22V17H19V14H17Z" />
                                </svg>
                                Add to Watchlist
                            </button>
                        {% else %}
                            <button name="toggle-watchlist" value="toggle-watchlist" class="watchlist-true">
                                <svg style="width:18px;height:18px" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M5.8 21L7.4 14L2 9.2L9.2 8.6L12 2L14.8 8.6L22 9.2L18.8 12H18C14.9 12 12.4 14.3 12 17.3L5.8 21M14 17V19H22V17H14Z" />
                                </svg>
                                Remove from Watchlist
                            </button>
                        {% endif %}
                    </form>
                {% endif %}
            </div>
            <div class="listing-page-seller-info">
                <h3>Seller Info</h3>
                <p><strong>Seller:</strong> {{ listing.user }}</p>
            </div>
            {% if user == listing.user %}
                <div class="listing-page-settings">
                    <div>
                        <h2>Listing Settings</h2>
                        <form id="listing-settings" action="{% url 'listing' listing.id %}" method="post">
                            {% csrf_token %}
                            <button name="delete" value="delete" onclick="return confirm('Are you sure you want to delete this listing?')">Delete Listing</button>
                            <button name="edit" value="edit">Edit Listing</button>
                            <button name="end" value="end" onclick="return confirm('Are you sure you want to end this listing?')">End Listing</button>
                        </form>
                    </div>
                </div>
            {% endif %}
            <div class="listing-page-bids">
                <h3>Bids</h3>
                {% if listing.is_active == True %}
                    <p><strong>Status: </strong>Active</p>
                    <p><strong>Starting bid:</strong> ${{ listing.starting_bid }}</p>
                    <p><strong>Current highest bid:</strong>
                        {% if current_highest_bid %}
                            ${{ current_highest_bid }}
                        {% else %}
                            No bids yet
                        {% endif %}
                        {% if current_highest_bidder %}
                            ({{ current_highest_bidder }})
                        {% endif %}
                    </p>
                {% else %}
                    <p><strong>Status:</strong> Finished</p>
                    {% if user == current_highest_bidder %}
                        <p><strong>Congratulations, {{ current_highest_bidder}}! You have won this listing with a bid of ${{ current_highest_bid }}</strong></p>
                    {% else %}
                        <p>Won by {{ current_highest_bidder }} with a bid of ${{ current_highest_bid }}</p>
                    {% endif %}
                {% endif %}
                {% if user.is_authenticated and listing.user != user and listing.is_active%}
                    <h3>Make new bid for this item</h3>
                    <form action="{% url 'listing' listing.id %}" method="post">
                        {% csrf_token %}
                        {{ bid_form }}
                        {% if bid_error %}
                            <p>{{ bid_error }}</p>
                        {% endif %}
                        <button type="submit">Submit bid</button>
                    </form>
                {% endif %}
            </div>
            <div class="listing-page-comments">
                <h3>Comments</h3>
                {% if comments %}
                    {% for comment in  comments %}
                        <h6>{{ comment.user }} {% if comment.user == listing.user %} <span> (SELLER) </span>{% endif %}</h6>
                        <p>{{ comment.comment }}</p>
                        <p class="comment-time-stamp">{{ comment.time_stamp }}</p>
                    {% endfor %}
                {% else %}
                    <p>No comments yet</p>
                {% endif %}
                {% if user.is_authenticated and listing.is_active %}
                    <form action="{% url 'listing' listing.id %}" method="post">
                        {% csrf_token %}
                        {{ comment_form }}
                        <button>Leave Comment</button>
                    </form>
                    {% if comment_error %}
                    <p>{{ comment_error }}</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}