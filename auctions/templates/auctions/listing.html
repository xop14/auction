{% extends "auctions/layout.html" %}

{% block body %}
    {% if error_message %}
        <h2>No Listing Found</h2>
    {% else %}
        <h2>Listing: {{ listing.title }}</h2>
        {% if listing.is_active == True %}
            <p>Status: Active</p>
        {% else %}
            <p>Status: Finished</p>
            {% if user == current_highest_bidder %}
                <h2>Congratulations, {{ current_highest_bidder}}! You have won this listing with a bid of ${{ current_highest_bid }}</h2>
            {% elif user == listing.user%}
                <h2>Won by {{ current_highest_bidder }} with a bid of ${{ current_highest_bid }}</h2>
            {% endif %}
        {% endif %}
        <p>Add to watch list</p>
        {% if listing.photo_url %}
            <img src="{{ listing.photo_url}}" width="400px" alt="{{ listing.title }}">
        {% endif %}
        <h3>Description</h3>
        <p>{{ listing.description }}</p>
        {% if user.is_authenticated and user != listing.user %}
            <form id="watchlist-toggle" action="{% url 'listing' listing.id %}" method="post">
                {% csrf_token %}
                {% if is_watchlist == False %}
                    <button name="toggle-watchlist" value="toggle-watchlist" class="watchlist-false">Add to Watchlist</button>
                {% else %}
                    <button name="toggle-watchlist" value="toggle-watchlist" class="watchlist-true">Remove from Watchlist</button>
                {% endif %}
            </form>
        {% endif %}
        <h3>Seller Info</h3>
        <p>Seller: {{ listing.user }}</p>
        <div>
            {% if user == listing.user %}
                <h2>Listing Settings</h2>
                <form id="listing-settings" action="{% url 'listing' listing.id %}" method="post">
                    {% csrf_token %}
                    <button name="delete" value="delete" onclick="return confirm('Are you sure you want to delete this listing?')">Delete Listing</button>
                    <button name="edit" value="edit">Edit Listing</button>
                    <button name="end" value="end" onclick="return confirm('Are you sure you want to end this listing?')">End Listing</button>
                </form>
            {% else %}
            {% endif %}
        </div>
        <h3>Bid Status</h3>
        <p>Starting bid: ${{ listing.starting_bid }}</p>
        <p>Current highest bid:
            {% if current_highest_bid %}
                ${{ current_highest_bid }}
            {% else %}
                No bids yet
            {% endif %}
            {% if current_highest_bidder %}
                ({{ current_highest_bidder }})
            {% endif %}
        </p>
        {% if user.is_authenticated and listing.user != user %}
            <h3>Make new bid for this item</h3>
            <form action="{% url 'listing' listing.id %}" method="post">
                {% csrf_token %}
                {{ bid_form }}
                {% if bid_error %}
                    <p>{{ bid_error }}</p>
                {% endif %}
                <button type="submit">Submit bid</button>
            </form>
        {% endif %}
        <h3>Comments</h3>
        {% if comments %}
            {% for comment in  comments %}
                <h6>{{ comment.user }} {% if comment.user == listing.user %} <span> (SELLER) </span>{% endif %}</h6>
                <p>{{ comment.comment }}</p>
                <p class="comment-time-stamp">{{ comment.time_stamp }}</p>
            {% endfor %}
        {% else %}
            <p>No comments yet</p>
        {% endif %}
        {% if user.is_authenticated %}
            <form action="{% url 'listing' listing.id %}" method="post">
                {% csrf_token %}
                {{ comment_form }}
                <button>Leave Comment</button>
            </form>
            {% if comment_error %}
            <p>{{ comment_error }}</p>
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}